import { ethers, network } from "hardhat";
import addressUtils from "../utils/addressUtils";

const CREATE2_DEPLOYER_ABI = require('../constants/proxy/create2-deployer.json');

const OWNABLE_PROXY_ABI = require('../constants/proxy/ownable-proxy.json');
const OWNABLE_PROXY_BYTECODE = "608060405234801561000f575f80fd5b506040516106a03803806106a083398181016040528101906100319190610218565b805f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036100a2575f6040517f1e4fbdf70000000000000000000000000000000000000000000000000000000081526004016100999190610265565b60405180910390fd5b6100b1816100f960201b60201c565b508160015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505061027e565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050815f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b5f80fd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6101e7826101be565b9050919050565b6101f7816101dd565b8114610201575f80fd5b50565b5f81519050610212816101ee565b92915050565b5f806040838503121561022e5761022d6101ba565b5b5f61023b85828601610204565b925050602061024c85828601610204565b9150509250929050565b61025f816101dd565b82525050565b5f6020820190506102785f830184610256565b92915050565b6104158061028b5f395ff3fe608060405260043610610037575f3560e01c8063715018a6146100605780638da5cb5b14610076578063f2fde38b146100a05761004e565b3661004e576100446100c8565b61004c61014f565b005b6100566100c8565b61005e61014f565b005b34801561006b575f80fd5b50610074610161565b005b348015610081575f80fd5b5061008a610174565b604051610097919061036d565b60405180910390f35b3480156100ab575f80fd5b506100c660048036038101906100c191906103b4565b61019b565b005b6100d061021f565b73ffffffffffffffffffffffffffffffffffffffff166100ee610174565b73ffffffffffffffffffffffffffffffffffffffff161461014d5761011161021f565b6040517f118cdaa7000000000000000000000000000000000000000000000000000000008152600401610144919061036d565b60405180910390fd5b565b61015f61015a610226565b61024e565b565b6101696100c8565b6101725f61026d565b565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b6101a36100c8565b5f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610213575f6040517f1e4fbdf700000000000000000000000000000000000000000000000000000000815260040161020a919061036d565b60405180910390fd5b61021c8161026d565b50565b5f33905090565b5f60015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b365f80375f80365f845af43d5f803e805f8114610269573d5ff35b3d5ffd5b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050815f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6103578261032e565b9050919050565b6103678161034d565b82525050565b5f6020820190506103805f83018461035e565b92915050565b5f80fd5b6103938161034d565b811461039d575f80fd5b50565b5f813590506103ae8161038a565b92915050565b5f602082840312156103c9576103c8610386565b5b5f6103d6848285016103a0565b9150509291505056fea2646970667358221220c8bad56273e5edc8800173339d96075bd8223400b1931e907657a12a6f8723bc64736f6c63430008160033"

const CREATE2_DEPLOYER_ADDR = "0x4f3492f39A528f369bf9FDC9986a7e71B921e4B6";
const MULTICALL_ADDR = "0x68cF7D5CEC3f8Cd69d7Bd842e1665818E46E2126";

function getSalt(input: string) {
    const utf8BytesValue = ethers.toUtf8Bytes(input);
    return ethers.keccak256(utf8BytesValue);
}

function getCodeData(abi: any, bytecode: any, args: any[]) {
    const iface = new ethers.Interface(abi);
    bytecode = bytecode.startsWith("0x") ? bytecode : "0x" + bytecode;
    return ethers.concat([bytecode, iface.encodeDeploy(args)]);
}

async function main() {
    const [signer] = await ethers.getSigners();

    const create2Deployer = new ethers.Contract(CREATE2_DEPLOYER_ADDR, CREATE2_DEPLOYER_ABI, signer);

    const accountNumber = "1123091823012830123";
    const computedSalt = getSalt(accountNumber);

    const codedata = getCodeData(OWNABLE_PROXY_ABI, OWNABLE_PROXY_BYTECODE, [MULTICALL_ADDR, signer.address]);

    // console.log("salt : ", computedSalt)
    // console.log("code data: ", codedata)

    const address = await create2Deployer.computeAddress(computedSalt, ethers.keccak256(codedata));
    console.log(address)

    const tx = await create2Deployer.deploy(0, computedSalt, codedata);
    console.log("Tx hash: ", tx.hash);

}

// We recommend this pattern to be able to use async/await everywhere
// and properly handle errors.
main().catch((error) => {
    console.error(error);
    process.exitCode = 1;
});
